<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/media/logo.png">
  <title>Checkout - myMart</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    /* ===== General Styles ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
    }

    /* ===== Navbar ===== */
    nav {
      background: #91ADC8;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .logo img {
      height: 50px;
    }

    .nav-links {
      display: flex;
      gap: 20px;
      list-style: none;
    }

    .nav-links a {
      text-decoration: none;
      color: #fff;
      font-size: 16px;
      transition: color 0.3s;
      font-weight: 500;
    }

    .nav-links a:hover {
      color: #ffcc00;
    }

    .actions {
      display: flex;
      gap: 15px;
    }

    .actions a {
      color: #fff;
      text-decoration: none;
      font-size: 16px;
      background: #ff7a18;
      padding: 8px 16px;
      border-radius: 6px;
      transition: background 0.3s;
      font-weight: 500;
    }

    .actions a:hover {
      background: #e26500;
    }

    .cart-count {
      background: #ff3333;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      position: absolute;
      top: -5px;
      right: -5px;
    }

    .cart-link {
      position: relative;
    }

    /* ===== Checkout Container ===== */
    .checkout-container {
      max-width: 1200px;
      margin: 100px auto 50px;
      padding: 0 20px;
    }

    .checkout-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .checkout-header h1 {
      font-size: 36px;
      color: #333;
      margin-bottom: 10px;
    }

    .checkout-header p {
      color: #666;
      font-size: 18px;
    }

    /* ===== Checkout Layout ===== */
    .checkout-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }

    /* ===== Checkout Form ===== */
    .checkout-form {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: #ff7a18;
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.2);
    }

    .form-options {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .form-options input {
      margin: 0;
    }

    /* ===== Payment Methods ===== */
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .payment-method {
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .payment-method:hover {
      border-color: #ff7a18;
    }

    .payment-method.selected {
      border-color: #ff7a18;
      background: rgba(255, 122, 24, 0.05);
    }

    .payment-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .payment-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    /* ===== UPI QR Code Section ===== */
    .upi-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      text-align: center;
      border: 2px dashed #e1e5e9;
      display: none;
    }

    .upi-section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .upi-header {
      margin-bottom: 20px;
    }

    .upi-header h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 8px;
    }

    .upi-header p {
      color: #666;
      font-size: 14px;
    }

    .qr-code-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 0 auto 20px;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .qr-code {
      width: 200px;
      height: 200px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      border: 1px solid #e1e5e9;
    }

    .qr-code canvas {
      border-radius: 4px;
    }

    .qr-amount-info {
      margin-top: 15px;
      padding: 12px;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      display: inline-block;
    }

    .qr-amount-info .amount {
      font-size: 20px;
      font-weight: bold;
      color: #d35400;
      margin-bottom: 5px;
    }

    .qr-amount-info .note {
      font-size: 12px;
      color: #856404;
    }

    .upi-apps {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .upi-app {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      color: #333;
    }

    /* ===== Cash on Delivery Section ===== */
    .cod-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      text-align: center;
      border: 2px dashed #e1e5e9;
      display: none;
    }

    .cod-section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    .cod-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .cod-info {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .cod-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .cod-feature {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .cod-feature-icon {
      font-size: 20px;
      margin-bottom: 8px;
      color: #ff7a18;
    }

    .cod-feature-text {
      font-size: 12px;
      color: #666;
    }

    /* ===== Order Summary ===== */
    .order-summary {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 120px;
    }

    .order-summary h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .order-items {
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .order-item {
      display: flex;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 15px;
    }

    .item-details {
      flex: 1;
    }

    .item-details h4 {
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }

    .item-details p {
      color: #666;
      font-size: 12px;
    }

    .item-price {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .order-totals {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .total-row:last-child {
      margin-bottom: 0;
      font-weight: 600;
      font-size: 18px;
      color: #ff7a18;
      border-top: 1px solid #e0e0e0;
      padding-top: 10px;
    }

    /* ===== Place Order Button ===== */
    .place-order-btn {
      background: #ff7a18;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 20px;
      position: relative;
      overflow: hidden;
    }

    .place-order-btn:hover {
      background: #e26500;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 122, 24, 0.3);
    }

    .place-order-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .place-order-btn.loading {
      color: transparent;
    }

    .place-order-btn.loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s ease infinite;
    }

    /* ===== Security Badge ===== */
    .security-badge {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .security-badge p {
      color: #666;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* ===== Animations ===== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Responsive Design ===== */
    @media (max-width: 992px) {
      .checkout-layout {
        grid-template-columns: 1fr;
      }
      
      .order-summary {
        position: static;
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .checkout-container {
        margin-top: 80px;
        padding: 0 15px;
      }

      .checkout-header h1 {
        font-size: 28px;
      }

      .checkout-form,
      .order-summary {
        padding: 20px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .payment-methods {
        grid-template-columns: repeat(2, 1fr);
      }

      .qr-code {
        width: 150px;
        height: 150px;
      }

      .cod-features {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .checkout-header h1 {
        font-size: 24px;
      }

      .order-item {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }

      .order-item img {
        margin-right: 0;
      }

      .payment-methods {
        grid-template-columns: 1fr;
      }

      .upi-apps {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <div class="logo"><img src="/media/logo.png" alt="myMart logo"></div>

    <ul class="nav-links">
      <li><a href="homePage.html">Home</a></li>
      <li><a href="shop.html">Shop</a></li>
      <li><a href="deals.html">Deals</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>

    <div class="actions">
      <a href="profile.html">My Account</a>
      <a href="cart.html" class="cart-link">Cart üõí <span class="cart-count">0</span></a>
    </div>
  </nav>

  <!-- Checkout Container -->
  <div class="checkout-container">
    <div class="checkout-header">
      <h1>Checkout</h1>
      <p>Complete your purchase with secure payment</p>
    </div>

    <div class="checkout-layout">
      <!-- Checkout Form -->
      <div class="checkout-form">
        <!-- Shipping Address -->
        <div class="form-section">
          <h2>Shipping Address</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" required>
            </div>
          </div>
          <div class="form-group">
            <label for="address">Street Address</label>
            <input type="text" id="address" placeholder="House no., Street, Area" required>
          </div>
          <div class="form-group">
            <label for="landmark">Landmark (Optional)</label>
            <input type="text" id="landmark" placeholder="Nearby landmark">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="city">City</label>
              <input type="text" id="city" required>
            </div>
            <div class="form-group">
              <label for="state">State</label>
              <select id="state" required>
                <option value="">Select State</option>
                <option value="MH">Maharashtra</option>
                <option value="DL">Delhi</option>
                <option value="KA">Karnataka</option>
                <option value="TN">Tamil Nadu</option>
                <option value="UP">Uttar Pradesh</option>
                <option value="GJ">Gujarat</option>
                <option value="RJ">Rajasthan</option>
                <option value="WB">West Bengal</option>
                <option value="AP">Andhra Pradesh</option>
                <option value="TS">Telangana</option>
                <option value="KL">Kerala</option>
                <option value="MP">Madhya Pradesh</option>
                <option value="HR">Haryana</option>
                <option value="PB">Punjab</option>
                <option value="BR">Bihar</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="pincode">PIN Code</label>
              <input type="text" id="pincode" pattern="[0-9]{6}" maxlength="6" required>
            </div>
            <div class="form-group">
              <label for="country">Country</label>
              <select id="country" required>
                <option value="IN" selected>India</option>
                <option value="US">United States</option>
                <option value="UK">United Kingdom</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" pattern="[0-9]{10}" maxlength="10" required>
          </div>
          <div class="form-group">
            <label for="instructions">Delivery Instructions (Optional)</label>
            <textarea id="instructions" rows="3" placeholder="Any specific delivery instructions..."></textarea>
          </div>
          <div class="form-options">
            <input type="checkbox" id="saveAddress">
            <label for="saveAddress">Save this address for future orders</label>
          </div>
        </div>

        <!-- Payment Method -->
        <div class="form-section">
          <h2>Payment Method</h2>
          <div class="payment-methods">
            <div class="payment-method selected" data-method="card" onclick="selectPaymentMethod('card')">
              <div class="payment-icon">üí≥</div>
              <div class="payment-name">Credit/Debit Card</div>
            </div>
            <div class="payment-method" data-method="upi" onclick="selectPaymentMethod('upi')">
              <div class="payment-icon">üì±</div>
              <div class="payment-name">UPI</div>
            </div>
            <div class="payment-method" data-method="cod" onclick="selectPaymentMethod('cod')">
              <div class="payment-icon">üí∞</div>
              <div class="payment-name">Cash on Delivery</div>
            </div>
            <div class="payment-method" data-method="netbanking" onclick="selectPaymentMethod('netbanking')">
              <div class="payment-icon">üè¶</div>
              <div class="payment-name">Net Banking</div>
            </div>
          </div>

          <!-- Credit Card Form -->
          <div id="cardForm">
            <div class="form-group">
              <label for="cardNumber">Card Number</label>
              <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="expiry">Expiry Date</label>
                <input type="text" id="expiry" placeholder="MM/YY" required>
              </div>
              <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" id="cvv" placeholder="123" required>
              </div>
            </div>
            <div class="form-group">
              <label for="cardName">Name on Card</label>
              <input type="text" id="cardName" required>
            </div>
          </div>

          <!-- UPI Section -->
          <div class="upi-section" id="upiSection">
            <div class="upi-header">
              <h3>Pay with UPI</h3>
              <p>Scan the QR code with any UPI app to complete payment</p>
            </div>
            
            <div class="qr-code-container">
              <div class="qr-code" id="dynamicQRCode">
                <!-- QR Code will be generated here -->
              </div>
            </div>

            <div class="qr-amount-info">
              <div class="amount" id="qrAmountDisplay">‚Çπ0.00</div>
              <div class="note">Amount will be automatically filled when scanned</div>
            </div>

            <div class="upi-apps">
              <div class="upi-app">Google Pay</div>
              <div class="upi-app">PhonePe</div>
              <div class="upi-app">Paytm</div>
              <div class="upi-app">BHIM</div>
              <div class="upi-app">Amazon Pay</div>
            </div>
            
            <p style="color: #666; font-size: 12px; margin-top: 15px;">
              After payment, you'll be redirected back to complete your order
            </p>
          </div>

          <!-- Cash on Delivery Section -->
          <div class="cod-section" id="codSection">
            <div class="cod-icon">üí∞</div>
            <h3>Cash on Delivery</h3>
            <p class="cod-info">Pay when you receive your order. No online payment required.</p>
            
            <div class="cod-features">
              <div class="cod-feature">
                <div class="cod-feature-icon">üõ°Ô∏è</div>
                <div class="cod-feature-text">100% Secure</div>
              </div>
              <div class="cod-feature">
                <div class="cod-feature-icon">üì¶</div>
                <div class="cod-feature-text">Pay on Delivery</div>
              </div>
              <div class="cod-feature">
                <div class="cod-feature-icon">üîç</div>
                <div class="cod-feature-text">Check Before Paying</div>
              </div>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-top: 15px;">
              <p style="color: #856404; font-size: 12px; margin: 0;">
                <strong>Note:</strong> A small convenience fee may apply for COD orders. Please keep exact change ready for the delivery executive.
              </p>
            </div>
          </div>

          <!-- Net Banking Section -->
          <div id="netbankingForm" style="display: none;">
            <div class="form-group">
              <label for="bank">Select Bank</label>
              <select id="bank" required>
                <option value="">Select your bank</option>
                <option value="sbi">State Bank of India</option>
                <option value="hdfc">HDFC Bank</option>
                <option value="icici">ICICI Bank</option>
                <option value="axis">Axis Bank</option>
                <option value="kotak">Kotak Mahindra Bank</option>
                <option value="pnb">Punjab National Bank</option>
                <option value="bob">Bank of Baroda</option>
                <option value="canara">Canara Bank</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Shipping Method -->
        <div class="form-section">
          <h2>Shipping Method</h2>
          <div class="form-group">
            <select id="shippingMethod" required>
              <option value="">Select Shipping Method</option>
              <option value="standard">Standard Delivery (5-7 days) - Free</option>
              <option value="express">Express Delivery (2-3 days) - ‚Çπ49</option>
              <option value="nextday">Next Day Delivery - ‚Çπ99</option>
              <option value="sameday">Same Day Delivery - ‚Çπ149</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>
        
        <div class="order-items" id="checkoutItems">
          <!-- Cart items will be dynamically populated here -->
        </div>

        <div class="order-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="checkoutSubtotal">‚Çπ0.00</span>
          </div>
          <div class="total-row">
            <span>Shipping:</span>
            <span id="checkoutShipping">Free</span>
          </div>
          <div class="total-row">
            <span>Tax (GST):</span>
            <span id="checkoutTax">‚Çπ0.00</span>
          </div>
          <div class="total-row">
            <span>Total:</span>
            <span id="checkoutTotal">‚Çπ0.00</span>
          </div>
        </div>

        <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">
          Place Order
        </button>

        <div class="security-badge">
          <p>
            <span>üîí</span>
            Secure checkout ‚Ä¢ Your information is safe with us
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Current order data
    let currentOrder = null;
    let selectedPaymentMethod = 'card';

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      loadCartItems();
      updateCartCount();
      loadUserData();
      setupEventListeners();
    });

    // Load cart items and display in checkout
    function loadCartItems() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const checkoutItems = document.getElementById('checkoutItems');
      const checkoutSubtotal = document.getElementById('checkoutSubtotal');
      const checkoutTax = document.getElementById('checkoutTax');
      const checkoutTotal = document.getElementById('checkoutTotal');
      const checkoutShipping = document.getElementById('checkoutShipping');

      checkoutItems.innerHTML = '';

      if (cart.length === 0) {
        checkoutItems.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Your cart is empty</p>';
        document.getElementById('placeOrderBtn').disabled = true;
        return;
      }

      // Calculate totals (in INR)
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const tax = subtotal * 0.18; // 18% GST
      const shipping = calculateShipping();
      const total = subtotal + tax + shipping;

      // Display items
      cart.forEach(item => {
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        
        orderItem.innerHTML = `
          <img src="${item.image || '/media/placeholder.jpg'}" alt="${item.name}" onerror="this.src='/media/placeholder.jpg'">
          <div class="item-details">
            <h4>${item.name}</h4>
            <p>${item.description || 'No description available'}</p>
            ${item.quantity > 1 ? `<p>Quantity: ${item.quantity}</p>` : ''}
          </div>
          <div class="item-price">‚Çπ${(item.price * item.quantity).toLocaleString()}</div>
        `;
        
        checkoutItems.appendChild(orderItem);
      });

      // Update totals
      checkoutSubtotal.textContent = `‚Çπ${subtotal.toLocaleString()}`;
      checkoutTax.textContent = `‚Çπ${tax.toLocaleString()}`;
      checkoutTotal.textContent = `‚Çπ${total.toLocaleString()}`;
      checkoutShipping.textContent = shipping === 0 ? 'Free' : `‚Çπ${shipping.toLocaleString()}`;

      // Store current order data
      currentOrder = {
        items: cart,
        subtotal: subtotal,
        shipping: shipping,
        tax: tax,
        total: total
      };

      // Generate QR code with payment amount
      generateQRCode(total);
    }

    // Generate UPI QR code with payment amount
    function generateQRCode(amount) {
      const qrCodeElement = document.getElementById('dynamicQRCode');
      const amountDisplay = document.getElementById('qrAmountDisplay');
      
      // Clear previous QR code
      qrCodeElement.innerHTML = '';
      
      // Update amount display
      amountDisplay.textContent = `‚Çπ${amount.toLocaleString()}`;
      
      // Create UPI payment URL with amount
      const upiId = 'mymart@upi'; // Replace with your actual UPI ID
      const paymentUrl = `upi://pay?pa=${upiId}&pn=myMart&am=${amount}&cu=INR&tn=Payment for myMart order`;
      
      // Generate QR code
      QRCode.toCanvas(qrCodeElement, paymentUrl, {
        width: 180,
        height: 180,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      }, function(error) {
        if (error) {
          console.error('QR Code generation error:', error);
          qrCodeElement.innerHTML = `
            <div style="text-align: center; color: #666; padding: 20px;">
              <div style="font-size: 16px; margin-bottom: 10px;">QR Code Error</div>
              <div style="font-size: 14px;">Please try another payment method</div>
            </div>
          `;
        }
      });
    }

    // Calculate shipping cost (in INR)
    function calculateShipping() {
      const shippingMethod = document.getElementById('shippingMethod').value;
      switch (shippingMethod) {
        case 'express':
          return 49;
        case 'nextday':
          return 99;
        case 'sameday':
          return 149;
        default:
          return 0; // Free standard shipping
      }
    }

    // Update cart count
    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
      document.querySelector('.cart-count').textContent = totalItems;
    }

    // Load user data if available
    function loadUserData() {
      const user = JSON.parse(localStorage.getItem('currentUser'));
      if (user && user.profile) {
        document.getElementById('firstName').value = user.profile.firstName || '';
        document.getElementById('lastName').value = user.profile.lastName || '';
        document.getElementById('phone').value = user.profile.phone || '';
        
        // Set India as default country
        document.getElementById('country').value = 'IN';
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Update totals when shipping method changes
      document.getElementById('shippingMethod').addEventListener('change', function() {
        if (currentOrder) {
          const shipping = calculateShipping();
          const total = currentOrder.subtotal + currentOrder.tax + shipping;
          
          document.getElementById('checkoutShipping').textContent = 
            shipping === 0 ? 'Free' : `‚Çπ${shipping.toLocaleString()}`;
          document.getElementById('checkoutTotal').textContent = `‚Çπ${total.toLocaleString()}`;
          
          currentOrder.shipping = shipping;
          currentOrder.total = total;

          // Update QR code with new amount
          generateQRCode(total);
        }
      });

      // Real-time validation
      document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
        e.target.value = formattedValue;
      });

      document.getElementById('expiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });

      // PIN code validation
      document.getElementById('pincode').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 6);
      });

      // Phone number validation
      document.getElementById('phone').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 10);
      });
    }

    // Select payment method
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // Update UI
      document.querySelectorAll('.payment-method').forEach(pm => {
        pm.classList.remove('selected');
      });
      document.querySelector(`[data-method="${method}"]`).classList.add('selected');
      
      // Show/hide forms
      document.getElementById('cardForm').style.display = 'none';
      document.getElementById('upiSection').classList.remove('active');
      document.getElementById('codSection').classList.remove('active');
      document.getElementById('netbankingForm').style.display = 'none';
      
      switch (method) {
        case 'card':
          document.getElementById('cardForm').style.display = 'block';
          break;
        case 'upi':
          document.getElementById('upiSection').classList.add('active');
          // Ensure QR code is updated with current amount
          if (currentOrder) {
            generateQRCode(currentOrder.total);
          }
          break;
        case 'cod':
          document.getElementById('codSection').classList.add('active');
          break;
        case 'netbanking':
          document.getElementById('netbankingForm').style.display = 'block';
          break;
      }
    }

    // Validate form
    function validateForm() {
      const requiredFields = [
        'firstName', 'lastName', 'address', 'city', 'state', 
        'pincode', 'country', 'phone', 'shippingMethod'
      ];

      for (let field of requiredFields) {
        const element = document.getElementById(field);
        if (!element.value.trim()) {
          showToast(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
          element.focus();
          return false;
        }
      }

      // Validate PIN code
      const pincode = document.getElementById('pincode').value;
      if (pincode.length !== 6) {
        showToast('Please enter a valid 6-digit PIN code', 'error');
        return false;
      }

      // Validate phone number
      const phone = document.getElementById('phone').value;
      if (phone.length !== 10) {
        showToast('Please enter a valid 10-digit phone number', 'error');
        return false;
      }

      // Validate payment method specific fields
      if (selectedPaymentMethod === 'card') {
        const cardFields = ['cardNumber', 'expiry', 'cvv', 'cardName'];
        for (let field of cardFields) {
          const element = document.getElementById(field);
          if (!element.value.trim()) {
            showToast(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
            element.focus();
            return false;
          }
        }

        // Basic card validation
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
        if (cardNumber.length !== 16 || !/^\d+$/.test(cardNumber)) {
          showToast('Please enter a valid 16-digit card number', 'error');
          return false;
        }

        const expiry = document.getElementById('expiry').value;
        if (!/^\d{2}\/\d{2}$/.test(expiry)) {
          showToast('Please enter a valid expiry date (MM/YY)', 'error');
          return false;
        }

        const cvv = document.getElementById('cvv').value;
        if (cvv.length < 3 || !/^\d+$/.test(cvv)) {
          showToast('Please enter a valid CVV', 'error');
          return false;
        }
      }

      if (selectedPaymentMethod === 'netbanking') {
        const bank = document.getElementById('bank').value;
        if (!bank) {
          showToast('Please select your bank', 'error');
          return false;
        }
      }

      return true;
    }

    // Place order
    function placeOrder() {
      if (!validateForm()) {
        return;
      }

      if (!currentOrder || currentOrder.items.length === 0) {
        showToast('Your cart is empty', 'error');
        return;
      }

      const placeOrderBtn = document.getElementById('placeOrderBtn');
      setLoadingState(placeOrderBtn, true);

      // Simulate payment processing
      setTimeout(() => {
        // Create complete order object
        const completeOrder = createCompleteOrder();
        
        // Save order to localStorage for confirmation page
        localStorage.setItem('currentOrder', JSON.stringify(completeOrder));
        
        // Save to order history
        saveOrderToHistory(completeOrder);
        
        // Clear cart
        localStorage.removeItem('cart');
        
        // Redirect to confirmation page
        window.location.href = 'order-confirmation.html';
      }, 2000);
    }

    // Create complete order object
    function createCompleteOrder() {
      const orderId = 'MYMART-' + Date.now().toString().slice(-6);
      const orderDate = new Date().toISOString();
      const estimatedDelivery = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString();

      return {
        id: orderId,
        items: currentOrder.items,
        subtotal: currentOrder.subtotal,
        shipping: currentOrder.shipping,
        tax: currentOrder.tax,
        total: currentOrder.total,
        currency: 'INR',
        shippingAddress: {
          name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
          street: document.getElementById('address').value,
          landmark: document.getElementById('landmark').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          pincode: document.getElementById('pincode').value,
          country: document.getElementById('country').value,
          phone: document.getElementById('phone').value,
          instructions: document.getElementById('instructions').value
        },
        paymentMethod: {
          type: getPaymentMethodName(selectedPaymentMethod),
          details: getPaymentMethodDetails()
        },
        deliveryMethod: {
          type: document.getElementById('shippingMethod').selectedOptions[0].text,
          estimatedDays: getEstimatedDays(document.getElementById('shippingMethod').value),
          trackingNumber: 'TRK' + Date.now().toString().slice(-9)
        },
        orderDate: orderDate,
        estimatedDelivery: estimatedDelivery
      };
    }

    // Get payment method name
    function getPaymentMethodName(method) {
      const methods = {
        'card': 'Credit/Debit Card',
        'upi': 'UPI',
        'cod': 'Cash on Delivery',
        'netbanking': 'Net Banking'
      };
      return methods[method] || method;
    }

    // Get payment method details
    function getPaymentMethodDetails() {
      switch (selectedPaymentMethod) {
        case 'card':
          return {
            last4: document.getElementById('cardNumber').value.slice(-4),
            expiry: document.getElementById('expiry').value
          };
        case 'upi':
          return {
            method: 'QR Code',
            status: 'Pending',
            amount: currentOrder.total
          };
        case 'cod':
          return {
            method: 'Cash',
            convenienceFee: 29
          };
        case 'netbanking':
          return {
            bank: document.getElementById('bank').selectedOptions[0].text
          };
        default:
          return {};
      }
    }

    // Get estimated delivery days
    function getEstimatedDays(shippingMethod) {
      switch (shippingMethod) {
        case 'express': return '2-3';
        case 'nextday': return '1';
        case 'sameday': return 'Same Day';
        default: return '5-7';
      }
    }

    // Save order to history
    function saveOrderToHistory(order) {
      const orders = JSON.parse(localStorage.getItem('userOrders')) || [];
      orders.unshift(order);
      localStorage.setItem('userOrders', JSON.stringify(orders));
    }

    // Set loading state
    function setLoadingState(button, isLoading) {
      if (isLoading) {
        button.disabled = true;
        button.classList.add('loading');
      } else {
        button.disabled = false;
        button.classList.remove('loading');
      }
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#2ecc71' : type === 'error' ? '#e74c3c' : '#3498db'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transform = 'translateY(0)';
        toast.style.opacity = '1';
      }, 100);
      
      setTimeout(() => {
        toast.style.transform = 'translateY(100px)';
        toast.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>